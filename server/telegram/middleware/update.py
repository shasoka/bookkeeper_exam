import asyncio
import random
from typing import Callable, Any, Awaitable

from aiogram import BaseMiddleware, html
from aiogram.types import TelegramObject

from resources.strings import SUCCESS_EFFECT_IDS
from services.entities_service import get_user, changelog_seen


class ChangeLogMiddleware(BaseMiddleware):
    # noinspection PyTypeChecker
    async def __call__(
        self,
        handler: Callable[[TelegramObject, dict[str, Any]], Awaitable[Any]],
        event: TelegramObject,
        data: dict[str, Any],
    ) -> Any:

        if event.from_user:
            user = await get_user(str(event.from_user.id))
            if not user.checked_update:
                await event.answer(
                    f"""
                    {html.code('[UPDATE CHANGELOG 18.06.2024]')}
                    \nüõ† 1. –ú–µ–Ω—è –ø–æ–¥–ª–∞—Ç–∞–ª–∏, –¥–∞–∂–µ –≤—ã–¥–∞–ª–∏ –º–Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ ‚ö°Ô∏è, —Ç–∞–∫ —á—Ç–æ —Ç–µ–ø–µ—Ä—å —è –Ω–µ –±—É–¥—É –ª–æ–º–∞—Ç—å—Å—è –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è (—Ö–æ—Ç—è –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç—ã —ç—Ç–æ–≥–æ –∏ –Ω–µ –∑–∞–º–µ—á–∞–ª) üí§
                    \n\nüìñ 2. –Ø —Ä–µ—à–∏–ª –ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å –º–µ—Ç–æ–¥–∏—á–∫—É —Å —Ç–µ—Å—Ç–∞–º–∏, —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å {html.spoiler(html.italic('–í–û–¢–¢–ê–ö–ò–ï–í–û–¢–°–õ–ò–ü–®–ò–ï–°–Ø–°–õ–û–í–ê') + ' üß≤')} –∏ {html.spoiler(html.italic('–ü–ï–†–ï-–ù–û–°–´ –ü–û –°–õ–û-–í–ê–ú') + ' ‚úÇÔ∏è')}
                    \n\nüö¶ 3. –í –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã –ø–æ—è–≤–∏–ª–∏—Å—å –º–∞—Ä–∫–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —Å –∫–∞–∫–∏–º–∏ —Ç–µ–º–∞–º–∏ —Ç—ã —É–∂–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è (üü¢, {html.bold('*—Ç–µ–º–∞ –ø–æ–ª—É—á–∏—Ç —ç—Ç–æ—Ç –º–∞—Ä–∫–µ—Ä, –µ—Å–ª–∏ —Ç—ã –ø—Ä–æ—Ä–µ—à–∞–µ—à—å –µ–µ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª –±–µ–∑ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫')}), –∫–∞–∫–∏–µ –ø–æ—â—É–ø–∞–ª, –Ω–æ –Ω–µ –ø—Ä–æ—à–µ–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é (üü†) –∏ –∫–∞–∫–∏–µ –¥–∞–∂–µ –Ω–µ –Ω–∞—á–∏–Ω–∞–ª (üî¥).
                    \n\nüñç 4. –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –∑–∞–ø–æ–º–Ω–∏–ª, –∫–∞–∫–∏–µ —Ç–µ–º—ã —Ç—ã —É–∂–µ –ø—Ä–æ—Ä–µ—à–∞–ª, –ø–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –æ—á–µ—Ä–µ–¥–Ω–æ–π —Ç–µ–º—ã —É —Ç–µ–±—è –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å {html.bold('—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ')} –æ—Ç–º–µ—Ç–∏—Ç—å –µ–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–π.
                    \n\nüíä 5. –ü–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞: {html.code('/heal')}. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è, –Ω–µ —Å–ø–µ—à–∏ –ø–∏—Å–∞—Ç—å {html.code('/restart')}, –ø—Ä–µ–±–µ—Ä–µ–≥–∏ —Å–≤–æ—é —Å–ª–æ–º–∞–Ω–Ω—É—é —Å–µ—Å—Å–∏—é, —è –ø–æ–ø—Ä–æ–±—É—é –µ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ –±—É–¥–µ—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ –∫–∞–∂–¥—ã–µ 10 –Ω–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π ({html.bold('*—Å–µ—Å—Å–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–æ–≤–æ–π, –µ—Å–ª–∏ –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞ –Ω–æ–≤–∞—è —Ç–µ–º–∞')}).
                    \n\n‚öôÔ∏è 6. –í –º–æ–µ–º –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ—è–≤–∏–ª–∞—Å—å —Å—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π üè†. –ü–æ–∫–∞ —á—Ç–æ —Ç–∞–º –Ω–µ –æ—á–µ–Ω—å —É—é—Ç–Ω–æ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–æ –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –º–æ–∂–µ—à—å –∑–∞–≥–ª—è–Ω—É—Ç—å, –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–∫ —è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.
                    \n\nüîÄ 7. –í –ø—Ä–æ—à–ª–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —è –∑–∞–±—ã–ª —É–ø–æ–º—è–Ω—É—Ç—å –æ —Ç–æ–º, —á—Ç–æ —Ç–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –≤—ã–±–∏—Ä–∞—Ç—å –±—É–¥—É—Ç –ª–∏ –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã –≤–æ–ø—Ä–æ—Å—ã –≤ —Ç–µ—Å—Ç–µ –∏–ª–∏ –Ω–µ—Ç. –ù–æ —Ç—ã –∏ —Ç–∞–∫ —É–∂–µ –∑–∞–º–µ—Ç–∏–ª üôÇ 
                    \n\n–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è, –ø–∏—à–∏ @shasoka
                    \n–ú–æ–∂–µ—à—å —Å–ø–æ–∫–æ–π–Ω–æ —É–¥–∞–ª—è—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ ü´•
                    \n–£—Å–ø–µ—Ö–æ–≤! ü§û
                    """,
                    disable_notification=False,
                    message_effect_id=random.choice(SUCCESS_EFFECT_IDS),
                )
                await changelog_seen(str(event.from_user.id))
                await asyncio.sleep(5)
        return await handler(event, data)
